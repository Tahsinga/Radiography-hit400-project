{% extends 'base.html' %}

{% block title %}Analytics Dashboard - MIC Radiology{% endblock %}

{% block body_class %}dashboard-theme{% endblock %}

{% block content %}
<div class="container-fluid mt-4 dashboard-theme">
    <div class="row" style="gap: 20px;">
        <!-- Left Column: Dashboard Controls -->
        <div class="col-md-6" style="max-height: 90vh; overflow-y: auto;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Analytics Dashboard</h2>
                <div class="btn-group" role="group">
                    <a href="?days=7" class="btn btn-sm" style="background: #f0f0f0; color: #1a1a1a; border: 1px solid #e0e0e0;">7 Days</a>
                    <a href="?days=30" class="btn btn-sm" style="background: #f0f0f0; color: #1a1a1a; border: 1px solid #e0e0e0; font-weight: bold;">30 Days</a>
                    <a href="?days=90" class="btn btn-sm" style="background: #f0f0f0; color: #1a1a1a; border: 1px solid #e0e0e0;">90 Days</a>
                </div>
            </div>

    <!-- KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h6 class="card-title">Total Appointments</h6>
                    <h2 class="mb-2">{{ total_appointments }}</h2>
                    <small>Last {{ time_range_days }} days</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h6 class="card-title">Completed</h6>
                    <h2 class="mb-2">{{ completed_appointments }}</h2>
                    <small>{{ completion_rate }}% completion rate</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h6 class="card-title">Missed Appointments</h6>
                    <h2 class="mb-2">{{ missed_appointments }}</h2>
                    <small>{{ missed_rate }}% no-show rate</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h6 class="card-title">Avg Satisfaction</h6>
                    <h2 class="mb-2">{{ avg_satisfaction }}/5.0</h2>
                    <small>Based on feedback</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Reports -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Appointments by Scan Type</h6>
                </div>
                <div class="card-body">
                    <canvas id="scanTypeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Revenue Summary</h6>
                </div>
                <div class="card-body">
                    <p><strong>Total Revenue:</strong> R{{ total_revenue }}</p>
                    <p><strong>Pending:</strong> R{{ pending_revenue }}</p>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 75%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Patient Satisfaction</h6>
                </div>
                <div class="card-body">
                    <p><strong>Would Recommend:</strong> {{ would_recommend_rate }}%</p>
                    <p><strong>Overall Satisfaction:</strong> {{ avg_satisfaction }}/5</p>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Payment Shortfalls</h6>
                </div>
                <div class="card-body">
                    <p><strong>Total Shortfalls:</strong> R{{ shortfalls.total_shortfall|default:"0" }}</p>
                    <p><strong>Cases:</strong> {{ shortfalls.count|default:"0" }}</p>
                </div>
            </div>
        </div>
    </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <button class="btn btn-sm" style="background: #f0f0f0; color: #1a1a1a; border: 1px solid #e0e0e0;" onclick="loadContentRight('{% url 'revenue_report' %}')">View Revenue Report</button>
                    <button class="btn btn-sm" style="background: #f0f0f0; color: #1a1a1a; border: 1px solid #e0e0e0;" onclick="loadContentRight('{% url 'feedback_analysis' %}')">View Feedback Analysis</button>
                </div>
            </div>
        </div>

        <!-- Right Column: Content Area -->
        <div class="col-md-6" style="max-height: 90vh; overflow-y: auto; border-left: 1px solid #e0e0e0; padding-left: 20px;">
            <div id="content-area">
                <div class="text-center" style="color: #666666; margin-top: 20px;">
                    <p>Click on a button to view detailed reports</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- HTML comments to prevent JS linting errors in Django templates -->
<script>
// Scan Type Chart
const scanData = {{ scan_breakdown|safe }}; // NOSONAR
const ctx = document.getElementById('scanTypeChart').getContext('2d');
new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: scanData.map(d => d.scan_type__name),
        datasets: [{
            data: scanData.map(d => d.count),
            backgroundColor: [
                '#cccccc',
                '#999999',
                '#666666',
                '#333333',
                '#dddddd'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true
    }
});

// Load content into right panel
function loadContentRight(url) {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    fetch(url)
        .then(response => response.text())
        .then(html => {
            // Extract main content from the response
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const mainContent = doc.querySelector('main') || doc.querySelector('[role="main"]') || doc.body;
            contentArea.innerHTML = mainContent.innerHTML;
        })
        .catch(error => {
            contentArea.innerHTML = '<div class="alert alert-danger">Error loading content. Please try again.</div>';
            console.error('Error:', error);
        });
}
</script>
{% endblock %}
